name: ğŸ”’ Auto-Update OWASP CRS Rules

on:
  schedule:
    - cron: '0 3 * * 1'  # æ¯å‘¨ä¸€ UTC 03:00 æ£€æŸ¥æ›´æ–°
  workflow_dispatch:
    inputs:
      target_version:
        description: 'æŒ‡å®šæ›´æ–°åˆ°çš„CRSç‰ˆæœ¬ (ç•™ç©ºåˆ™ä½¿ç”¨æœ€æ–°ç‰ˆ)'
        required: false
        type: string

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current CRS version
        id: current
        run: |
          CURRENT=$(cat .crs-version 2>/dev/null || echo "v4.15.0")
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current CRS version: $CURRENT"

      - name: Fetch latest CRS release
        id: latest
        run: |
          if [ -n "${{ github.event.inputs.target_version }}" ]; then
            LATEST="${{ github.event.inputs.target_version }}"
            echo "Using specified version: $LATEST"
          else
            # è·å–æœ€æ–°æ­£å¼å‘å¸ƒç‰ˆæœ¬ï¼ˆè·³è¿‡é¢„å‘å¸ƒï¼‰
            LATEST=$(curl -s https://api.github.com/repos/coreruleset/coreruleset/releases/latest | \
              jq -r '.tag_name // empty' | head -1)
            if [ -z "$LATEST" ]; then
              echo "Error: Failed to fetch latest CRS version"
              exit 1
            fi
          fi
          echo "latest_version=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest CRS version: $LATEST"

      - name: Compare versions
        id: compare
        run: |
          if [ "${{ steps.current.outputs.current_version }}" = "${{ steps.latest.outputs.latest_version }}" ]; then
            echo "No update needed. Current version is up-to-date."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "Update needed! ${steps.current.outputs.current_version} â†’ ${steps.latest.outputs.latest_version}"
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "old_version=${{ steps.current.outputs.current_version }}" >> $GITHUB_OUTPUT
            echo "new_version=${{ steps.latest.outputs.latest_version }}" >> $GITHUB_OUTPUT
          fi

      - name: Update CRS version file
        if: steps.compare.outputs.update_needed == 'true'
        run: |
          echo "${{ steps.latest.outputs.latest_version }}" > .crs-version
          cat .crs-version

      - name: Create Pull Request
        if: steps.compare.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(security): update OWASP CRS to ${{ steps.latest.outputs.latest_version }}"
          branch: "update/crs-${{ steps.latest.outputs.latest_version }}"
          delete-branch: true
          title: "ğŸ”’ Update OWASP CRS to ${{ steps.latest.outputs.latest_version }}"
          body: |
            ## ğŸ“Œ CRS Update Summary
            - **Previous version**: `${{ steps.compare.outputs.old_version }}`
            - **New version**: `${{ steps.latest.outputs.latest_version }}`
            - **Release notes**: https://github.com/coreruleset/coreruleset/releases/tag/${{ steps.latest.outputs.latest_version }}
            
            ## ğŸ” Changes to verify
            - [ ] No increase in false positives (test with your traffic patterns)
            - [ ] Critical business endpoints still accessible
            - [ ] Check [CRS changelog](https://github.com/coreruleset/coreruleset/blob/${{ steps.latest.outputs.latest_version }}/CHANGES.md) for breaking changes
            - [ ] Run security scan: `docker run --rm ghcr.io/${{ github.repository }}:test caddy validate`
            
            ## âš ï¸ Security note
            This update includes rules for:
            ```bash
            curl -s https://api.github.com/repos/coreruleset/coreruleset/releases/tags/ $ {{ steps.latest.outputs.latest_version }} | jq -r '.body'
            ```
            
            *This PR was created automatically by GitHub Actions. Merge only after validation.*
          labels: security, dependencies, automated-pr
          reviewers: ${{ github.repository_owner }}

      - name: No update needed
        if: steps.compare.outputs.update_needed != 'true'
        run: echo "âœ… CRS is already up-to-date. No action required."
